#!/bin/bash

# =============================================================================
# ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå…¨éƒ¨ã¾ã¨ã‚ã¦å®Ÿè¡Œï¼‰
# =============================================================================

set -e

echo "ðŸš€ kokushimen-client ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼å®Ÿè¡Œ"
echo "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â†’ ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼èµ·å‹• â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè¡Œ"
echo ""

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ
echo "ðŸ“¦ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹..."
chmod +x setup_raspi.sh
./setup_raspi.sh

echo ""
echo "â±ï¸  3ç§’å¾Œã«ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™..."
sleep 3

# ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
echo "ðŸ–¥ï¸  ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•..."
chmod +x start_mock_server.sh
./start_mock_server.sh &
SERVER_PID=$!

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å¾…ã¤
echo "â±ï¸  ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
for i in {1..10}; do
    if curl -s http://127.0.0.1:8000/ >/dev/null 2>&1; then
        echo "âœ… ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ"
        break
    fi
    echo "å¾…æ©Ÿä¸­... ($i/10)"
    sleep 2
done

echo ""
echo "ðŸŽ¤ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èµ·å‹•ã—ã¾ã™..."
echo "åœæ­¢ã™ã‚‹ã«ã¯ Ctrl+C ã‚’æŠ¼ã—ã¦ãã ã•ã„"
echo ""

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè¡Œ
chmod +x run_client.sh
./run_client.sh

# çµ‚äº†æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚‚åœæ­¢
trap "kill $SERVER_PID 2>/dev/null" EXIT
